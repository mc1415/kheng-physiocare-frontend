const translations = {
  en: {
    adminPortal: 'Admin Portal',
    signInPrompt: 'Please sign in to continue',
    emailAddress: 'Email Address',
    password: 'Password',
    signIn: 'Sign In',
    invalidCredentials: 'Invalid credentials. Please try again.',
    dashboard: 'Dashboard',
    appointments: 'Appointments',
    patients: 'Patients',
    billing: 'Billing',
    exercises: 'Exercises',
    inventory: 'Inventory',
    staff: 'Staff',
    settings: 'Settings',
    logout: 'Logout',
    searchPlaceholder: 'Search...',
    generalReport: 'General Report',
    consultations: 'Consultations',
    last30Days: 'Last 30 Days',
    todaysRevenue: "TODAY'S REVENUE",
    appointmentsToday: 'APPOINTMENTS TODAY',
    newPatientsToday: 'NEW PATIENTS TODAY',
    cancellationsToday: 'CANCELLATIONS TODAY',
    welcome: 'Welcome',
    yourExercisePlan: 'Your Exercise Plan',
    appointmentHistory: 'Appointment History',
    clinicInformation: 'Clinic Information',
    latestUpdates: 'Latest Updates',
    invoices: 'Invoices',
    patientInformation: 'Patient Information',
    ageLabel: 'Age',
    genderLabel: 'Gender',
    phoneLabel: 'Phone',
    emailLabel: 'Email',
    noAppointments: 'You have no upcoming appointments.',
    nextAppointment: 'Next Appointment',
    at: 'at',
    with: 'with',
    noExercises: 'You have no exercises assigned at the moment.',
    markAsDone: 'Mark as Done',
    completedToday: 'Completed Today!',
    saving: 'Saving...',
    noPastAppointments: 'No past appointments found.',
    progressOverview: 'Progress Overview',
    changePassword: 'Change Password',
    currentPassword: 'Current Password',
    newPassword: 'New Password',
    confirmPassword: 'Confirm New Password',
    updatePassword: 'Update Password',
    tempPasswordHint: 'Temporary password for new accounts:',
    patientFallback: 'Patient',
    noInvoices: 'No invoices available yet.',
    downloadInvoice: 'Download PDF',
    completedExercises: 'Completed',
    pendingExercises: 'Pending',
    loading: 'Loading...',
    newAppointment: 'New Appointment',
    saveAppointment: 'Save Appointment',
    delete: 'Delete',
    createInvoice: 'Create New Invoice',
    addExercise: 'Add New Exercise',
    allExercises: 'All Exercises',
    addProduct: 'Add New Product',
    allProducts: 'All Products',
    addStaff: 'Add New Staff',
    allStaff: 'All Staff Members',
    addPatient: 'Add New Patient',
    allPatients: 'All Patients',
    backToPatients: 'Back to All Patients',
    clinicalNotes: 'Clinical Notes',
    bookNow: 'Book Now',
    navHome: 'Home',
    navAbout: 'About Us',
    navServices: 'Services',
    navContact: 'Contact',
    patientPortalLoginTitle: 'Patient Portal Login',
    patientPortalLoginIntro: 'Access your appointments, exercises, and invoices in one secure place.',
    loginHeroSubtitle: 'Sign in to continue your care plan, track progress, and reach your goals faster.',
    loginHeroBullet1: 'See your upcoming appointments at a glance.',
    loginHeroBullet2: 'Complete daily exercise videos tailored to you.',
    loginHeroBullet3: 'Securely download receipts and invoices any time.',
    loginHelpText: 'Need help? Contact our support team and we\'ll be happy to assist.',
    footerRights: 'Copyright 2024 Kheng PhysioCare. All rights reserved.'
  },
  km: {
    adminPortal: 'ផ្ទាំងគ្រប់គ្រងរដ្ឋបាល',
    signInPrompt: 'សូមចូលគណនីដើម្បីបន្ត',
    emailAddress: 'អាសយដ្ឋាន​អ៊ីម៉ែល',
    password: 'ពាក្យសម្ងាត់',
    signIn: 'ចូល',
    invalidCredentials: 'ព័ត៌មានសម្គាល់ខ្លួនមិនត្រឹមត្រូវ សូមព្យាយាមម្តងទៀត',
    dashboard: 'ផ្ទាំងគ្រប់គ្រងរដ្ឋបាល',
    appointments: 'ការណាត់ជួប',
    patients: 'អ្នកជំងឺ',
    billing: 'វិក្កយបត្រ',
    exercises: 'លំហាត់ប្រាណ',
    inventory: 'ស្តុកទំនិញ',
    staff: 'បុគ្គលិក',
    settings: 'ការកំណត់',
    logout: 'ចាកចេញ',
    searchPlaceholder: 'ស្វែងរក...',
    generalReport: 'របាយការណ៍ទូទៅ',
    consultations: 'ការពិគ្រោះយោបល់',
    last30Days: '៣០ ថ្ងៃចុងក្រោយ',
    todaysRevenue: 'ចំណូលថ្ងៃនេះ',
    appointmentsToday: 'ការណាត់ជួបថ្ងៃនេះ',
    newPatientsToday: 'អ្នកជំងឺថ្មីថ្ងៃនេះ',
    cancellationsToday: 'ការលុបចោលថ្ងៃនេះ',
    welcome: 'សូមស្វាគមន៍',
    yourExercisePlan: 'ផែនការហាត់ប្រាណ​របស់អ្នក',
    appointmentHistory: 'ប្រវត្តិនៃការណាត់ជួប',
    clinicInformation: 'ព័ត៌មានគ្លីនិក',
    latestUpdates: 'បច្ចុប្បន្នភាពថ្មីៗ',
    invoices: 'វិក្កយបត្រ',
    patientInformation: 'ព័ត៌មានអ្នកជម្ងឺ',
    ageLabel: 'អាយុ',
    genderLabel: 'ភេទ',
    phoneLabel: 'លេខទូរស័ព្ទ',
    emailLabel: 'អ៊ីមែល',
    noAppointments: 'អ្នកមិនមានការណាត់ជួបពេលខាងមុខទេ',
    nextAppointment: 'ការណាត់ជួបបន្ទាប់',
    at: 'នៅ',
    with: 'ជាមួយ',
    noExercises: 'អ្នកមិនមានលំហាត់ប្រាណដែលបានកំណត់ទេ',
    markAsDone: 'សម្គាល់ថាបានធ្វើរួច',
    completedToday: 'បានបញ្ចប់ថ្ងៃនេះ',
    saving: 'កំពុងរក្សាទុក...',
    noPastAppointments: 'ប្រវត្តិណាត់ជួបមិនមានទេ',
    progressOverview: 'សង្ខេបការរីកចម្រើន',
    completedExercises: 'បានបញ្ចប់',
    pendingExercises: 'មិនទាន់ធ្វើ',
    loading: 'កំពុងដំណើរការ',
    changePassword: 'ប្តូរពាក្យសម្ងាត់',
    currentPassword: 'ពាក្យសម្ងាត់បច្ចុប្បន្ន',
    newPassword: 'ពាក្យសម្ងាត់ថ្មី',
    confirmPassword: 'បញ្ជាក់ពាក្យសម្ងាត់ថ្មី',
    updatePassword: 'រក្សាទុកពាក្យសម្ងាត់',
    tempPasswordHint: 'ប្រសិនបើជាគណនីថ្មី នេះជាពាក្យសម្ងាត់បណ្តោះអាសន្ន៖',
    patientFallback: 'អ្នកជម្ងឺ',
    noInvoices: 'មិនទាន់មានវិក្កយបត្រ។',
    downloadInvoice: 'ទាញយក PDF',
    newAppointment: 'ការណាត់ជួបថ្មី',
    saveAppointment: 'រក្សាទុកការណាត់ជួប',
    delete: 'លុប',
    createInvoice: 'បង្កើតវិក្កយបត្រថ្មី',
    addExercise: 'បន្ថែមលំហាត់ប្រាណថ្មី',
    allExercises: 'លំហាត់ប្រាណទាំងអស់',
    addProduct: 'បន្ថែមផលិតផលថ្មី',
    allProducts: 'ផលិតផលទាំងអស់',
    addStaff: 'បន្ថែមបុគ្គលិកថ្មី',
    allStaff: 'បុគ្គលិកទាំងអស់',
    addPatient: 'បន្ថែមអ្នកជំងឺថ្មី',
    allPatients: 'អ្នកជំងឺទាំងអស់',
    backToPatients: 'ត្រឡប់ទៅអ្នកជំងឺទាំងអស់',
    clinicalNotes: 'កំណត់ត្រាគ្លីនិក',

    bookNow: 'Book Now',
    navHome: 'Home',
    navAbout: 'About Us',
    navServices: 'Services',
    navContact: 'Contact',
    patientPortalLoginTitle: 'Patient Portal Login',
    patientPortalLoginIntro: 'Access your appointments, exercises, and invoices in one secure place.',
    loginHeroSubtitle: 'Sign in to continue your care plan, track progress, and reach your goals faster.',
    loginHeroBullet1: 'See your upcoming appointments at a glance.',
    loginHeroBullet2: 'Complete daily exercise videos tailored to you.',
    loginHeroBullet3: 'Securely download receipts and invoices any time.',
    loginHelpText: 'Need help? Contact our support team and we\'ll be happy to assist.',
    footerRights: 'Copyright 2024 Kheng PhysioCare. All rights reserved.'
  }
};

function t(key) {
  const lang = localStorage.getItem('lang') || 'en';
  return translations[lang][key] || translations['en'][key] || key;
}

function translatePage() {
  const lang = localStorage.getItem('lang') || 'en';
  document.documentElement.setAttribute('lang', lang);
  if (document.body) document.body.classList.toggle('lang-km', lang === 'km');
  const langPack = translations[lang] || {};
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const hasTranslation = Object.prototype.hasOwnProperty.call(langPack, key);
    const translation = hasTranslation ? langPack[key] : (translations['en'][key] || key);
    if (el.tagName.toLowerCase() === 'input' || el.tagName.toLowerCase() === 'textarea') {
      el.value = translation;
    } else {
      el.textContent = translation;
    }
    el.classList.toggle('use-base-font', lang === 'km' && !hasTranslation);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    const hasTranslation = Object.prototype.hasOwnProperty.call(langPack, key);
    const translation = hasTranslation ? langPack[key] : (translations['en'][key] || key);
    el.placeholder = translation;
    el.classList.toggle('use-base-font', lang === 'km' && !hasTranslation);
  });
  const selector = document.getElementById('language-select');
  if (selector) selector.value = lang;
  const patientNameEl = document.getElementById('mobile-profile-name');
  if (patientNameEl && patientNameEl.dataset.hasName !== 'true') {
    patientNameEl.textContent = t('patientFallback');
  }
  if (typeof window.refreshPatientInfoLanguage === 'function') {
    window.refreshPatientInfoLanguage();
  }
  highlightLanguageMenu(lang);
}

function setLanguage(lang) {
  localStorage.setItem('lang', lang);
  translatePage();
  closeAllLanguageMenus();
}

function highlightLanguageMenu(lang) {
  document.querySelectorAll('.language-menu [data-lang]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });
}

const languageSwitchers = [];
let languageMenuClickHandlerBound = false;

function closeAllLanguageMenus() {
  languageSwitchers.forEach(({ menu, toggle }) => {
    menu.classList.remove('open');
    toggle.setAttribute('aria-expanded', 'false');
  });
}

function initLanguageMenu() {
  languageSwitchers.length = 0;
  const configs = [
    { toggle: document.getElementById('language-toggle'), menu: document.getElementById('language-menu') }
  ];
  configs.forEach(({ toggle, menu }) => {
    if (!toggle || !menu) return;
    languageSwitchers.push({ toggle, menu });
    if (toggle.dataset.languageBound === 'true') return;
    toggle.dataset.languageBound = 'true';
    toggle.addEventListener('click', (event) => {
      event.stopPropagation();
      const willOpen = !menu.classList.contains('open');
      closeAllLanguageMenus();
      if (willOpen) {
        menu.classList.add('open');
        toggle.setAttribute('aria-expanded', 'true');
      } else {
        toggle.setAttribute('aria-expanded', 'false');
      }
    });
    menu.addEventListener('click', (event) => {
      const btn = event.target.closest('button[data-lang]');
      if (!btn) return;
      setLanguage(btn.dataset.lang);
      closeAllLanguageMenus();
    });
  });
  if (!languageMenuClickHandlerBound) {
    document.addEventListener('click', (event) => {
      if (languageSwitchers.some(({ menu, toggle }) => menu.contains(event.target) || toggle.contains(event.target))) return;
      closeAllLanguageMenus();
    });
    languageMenuClickHandlerBound = true;
  }
  highlightLanguageMenu(localStorage.getItem('lang') || 'en');
}

document.addEventListener('DOMContentLoaded', () => {
  translatePage();
  initLanguageMenu();
});

window.setLanguage = setLanguage;
window.translatePage = translatePage;
window.t = t;
